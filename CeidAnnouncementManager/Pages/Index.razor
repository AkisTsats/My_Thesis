@page "/"
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavManager;

@using System.Text.Json
@using System.Text.Json.Serialization;
@using DTOs.Data;
@using static DTOs.Common.Helpers;
@using DTOs.API.Responses;

@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Security.Claims

@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Διαχείρηση Ανακοινώσεων του ΤΜΗΥΠ</PageTitle>

<MudGrid Justify="Justify.Center" Class="d-flex" Spacing="2" Style="align-items: center">
    <MudImage Src="icon-192.jpg" Class="ma-6" Width="210" Height="55" />
    @if (_myAnnouncementDtos != null)
    {
        @foreach (var myVar in _myAnnouncementDtos)
        {
            var annID = myVar.AnnID;
            <MudItem xs="10" aling-center>
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@myVar.Title</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudText Typo="Typo.h6">@myVar.Date</MudText>
                            @* <MudIconButton Icon="@Icons.Material.Filled.Settings"/> *@
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText>@myVar.Author</MudText>
                        <MudText Typo="Typo.body2">@myVar.Abstract</MudText>
                    </MudCardContent>
                    @* @foreach (var tag in myVar.Tags)
                    {
                         <MudChip Label="@tag" /> 
                    } *@
                    <MudCardActions>
                        <MudButton OnClick="() => NavigateTo(annID)" Variant="Variant.Text">Read More</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }

        <MudItem xs="5"></MudItem>
        <MudItem xs="6">
            <MudPagination SelectedChanged="PageChanged" Count="@numOfPages" />
        </MudItem>
    }
</MudGrid>

@code {

    private bool isVisible;
    public void ToggleOverlay(bool value)
    {
        isVisible = value;
    }

    private int _selected = 1;
    private int numOfPages = 1;
    private int pageSize = 10;

    public async Task<IEnumerable<AnnouncementDTO>> GetWebApiResponse()//TODO Move to Announcements repository
    {
        string s1 = pageSize.ToString();
        string s2 = _selected.ToString();
        var response = await Http.GetStringAsync("https://localhost:5001/api/Public/GetAnnouncements?" + "limit=" + s1 + "&skip=" + s2);

        //string serializedString = System.Text.Json.JsonSerializer.Serialize(response);

        Console.WriteLine(response);
        //Console.WriteLine(serializedString);

        var annResponse = response.DeserializeMethod<GetAnnouncementsByResponse>();

        int count = annResponse.SumOfAnnouncements;

        numOfPages = getPageCount(count);


        var ann = annResponse.Announcements;

        return ann;

    }

    private int getPageCount(int count)//TODO Move to Announcements repository
    {
        //count % pageSize == 0 ? numOfPages = (count/pageSize) : numOfPages = (count/pageSize) + 1;
        if (count % pageSize == 0)
        {
            numOfPages = (count / pageSize);
        }
        else
        {
            numOfPages = (count / pageSize) + 1;
        }

        return numOfPages;
    }

    public async Task<IEnumerable<AnnouncementDTO>> FetchAnnouncementsResponse()
    {
        _allAnnouncementDtos = await GetWebApiResponse();
        return _allAnnouncementDtos;
    }



    public async Task<IEnumerable<AnnouncementDTO>> PageChanged(int i)
    {
        _selected = i;
        _change = await FetchAnnouncementsResponse();
        _myAnnouncementDtos = _change;
        return _change;
    }


    private void NavigateTo(int id)
    {
        var s = id.ToString();
        NavManager.NavigateTo("showannouncement/" + s);
    }

    private IEnumerable<AnnouncementDTO> _myAnnouncementDtos;
    private IEnumerable<AnnouncementDTO> _allAnnouncementDtos;
    private IEnumerable<AnnouncementDTO> _change;

    protected override async Task OnInitializedAsync()
    {
        await GetClaimsPrincipalData();
        _myAnnouncementDtos = await FetchAnnouncementsResponse();
    }

    private void click(int id)
    {
        NavManager.NavigateTo($"showannouncement/{id}");
    }

    private IEnumerable<Claim> claims = Enumerable.Empty<Claim>();

    //protected override Task OnInitializedAsync() => GetClaimsPrincipalData();

    private async Task GetClaimsPrincipalData()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated ?? false)
        {
            claims = user.Claims;
        }
        foreach (var claim in claims)
        {
            if (claim.Type == "email")
            {
                var mail = claim.Value;
                Console.WriteLine(mail);
            }
        }
    }

}
